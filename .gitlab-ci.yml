---
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push"'

test:
  image: archlinux:base-devel
  before_script:
    - pacman -Syu --noconfirm asciidoc perl
    - ./autogen.sh
    - ./configure
    - make
  script: make check

.lint-workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || ($CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push")'
      changes:
        paths:
          - $FILE_GLOB
        compare_to: 'master'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"'
      when: never

cppcheck:
  image: alpine
  variables:
    FILE_GLOB: "src/*.c"
  before_script:
    - apk add cppcheck
  script:
    - cppcheck --error-exitcode=1 .
  rules:
    - !reference [.lint-workflow, rules]

markdownlint:
  image:
    name: davidanson/markdownlint-cli2
    entrypoint: ['']
  variables:
    FILE_GLOB: "*.md"
  script:
    - markdownlint-cli2
  rules:
    - !reference [.lint-workflow, rules]

shellcheck:
  image: koalaman/shellcheck-alpine
  variables:
    FILE_GLOB: "**/*.sh*"
  script:
    - find . -name '*.sh*' -exec shellcheck --color=always {} +
  rules:
    - !reference [.lint-workflow, rules]

vint:
  image: alpine
  variables:
    FILE_GLOB: "src/vim/*/*.vim"
  before_script:
    - apk add vint py3-setuptools
  script:
    - vint src/vim
  rules:
    - !reference [.lint-workflow, rules]
